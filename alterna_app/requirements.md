# 要件定義書

## はじめに

三井物産デジタル・アセットマネジメント（MDM）の個人向けデジタル証券サービス「ALTERNA（オルタナ）」に関する新着案件（先着/抽選）・評判・償還実績を、RSS/公式ソース中心に低保守で定点観測するライト版WEBダッシュボードを開発する。

本システムはNext.js 15ベースのSPAとして実装し、Supabase（Postgres/RLS/Storage/Edge Functions）を活用してデータ管理とバッチ処理を行う。非公式個人開発として、各情報源の利用規約/robots.txt/著作権指針の順守を最優先とする。

### 成果物（MVP）
1. Next.js 15ベースのSPA
2. Page-1: ニュース配信の一覧（タイムライン形式）
3. Page-2: 投資案件一覧（スナップショット画像表示）
4. Supabaseによるデータ管理とバッチ処理
5. app/layout.tsx にタブナビ（ニュース/スナップショット）を常設する

## **注記）**
* 本案件は情報系大学での演習課題であり、生成AIとの作業記録を README ファイルに記録し、それを成果報告書に添付する。  
* READMEファイルは成績評価対象書類となるため、要約・簡略化せず、作業工程を記録する。  
* 開発はユーザー単独作業とし、生成AIとの共同作業において、生成AIは、要所で開発方針をユーザーに確認するhuman-in-the-loop方式を採用する。   
* 開発内容につき、ユーザーが大学にて成果報告会を実施できるように、生成AIは初学者向けに開発内容の要点を表示する。


## 要件

### 要件1

**ユーザーストーリー:** 潜在的投資家として、ALTERNAの新しい投資機会をタイムライン形式で確認し、先着順と抽選方式の案件を迅速に識別したい。

#### 受入基準

1. Page-1にアクセスした時、システムは公開日時降順でニュースをタイムライン形式で表示すること
2. ニュース項目を表示する時、システムはイベント種別タグ、想定利回り、最低投資額、リンクを表示すること
3. 新しい機会が見つかった時、システムは先着順と抽選方式を明確に分類すること
4. ユーザーがフィルタリングを必要とする時、システムは期間、種別、抽選/先着ステータスによるフィルタを提供すること

#### イベント種別定義（event_type）
- **NEW_LISTING**: 新着案件（募集開始）
- **REDEMPTION**: 償還・分配情報
- **RESULT**: 抽選結果・運用結果
- **REVIEW**: 評判・レビュー情報

#### 申込方式定義（subscription_method）
- **FCFS**: 先着順（First Come, First Served）
- **DRAW**: 抽選方式

### 要件2

**ユーザーストーリー:** 投資家として、投資機会のスナップショットを確認し、ニュース更新に加えて実際の募集ページを見たい。

#### 受入基準

1. `/snapshots`ページにアクセスした時、システムは投資機会のスナップショットをグリッド形式で表示すること
2. スナップショットを表示する時、システムはal_offering_snapsテーブルに保存されたPNG画像を表示すること
3. ユーザーがスナップショット画像をクリックした時、システムは元の募集URLにリダイレクトすること
4. スナップショット画像を読み込む時、システムは`GET /api/snapshots`から取得した署名付きURLを使用すること
5. API契約として、`GET /api/snapshots`は`{ok: boolean, items: Array<{...signed_url: string|null}>}`形式でレスポンスすること

### 要件3

**ユーザーストーリー:** システム管理者として、RSSフィードの自動収集により、最小限の手動介入でダッシュボードを最新状態に保ちたい。

#### 受入基準

1. システムがスケジュールタスクを実行する時、Supabase Edge Functionsとスケジューラを使用すること
2. RSSフィードを収集する時、システムはsources_raw、al_tr_events、al_tr_performanceテーブルにデータを保存すること
3. RSS収集が失敗した時、システムはエラーを適切に処理し、問題をログに記録すること
4. 新しいデータが収集された時、API経由でフロントエンドに自動的に利用可能になること

### 要件4

**ユーザーストーリー:** システム管理者として、機密情報が適切に保護されるよう、安全なデータ管理を行いたい。

#### 受入基準

1. al_offering_snapsテーブルを管理する時、フロントエンドからの直接アクセスを一切許可しない完全プライベート設定とすること
2. スナップショット画像にアクセスする時、システムはService Roleで生成された署名付きURLを使用すること
3. 画像を保存する時、Storageバケットはプライベート設定とし、バケット限定条件付きのポリシーを設定すること
4. ニュースデータを処理する時、RLSは匿名SELECTのみを許可すること
5. Service Role Keyを使用する時、lib/supabase/service-role.tsファイルでimport "server-only"を先頭に配置し、クライアントサイドコードに一切露出させないこと
6. Service Roleを使用するAPIルートでは、export const runtime = "nodejs"を設定すること

#### 環境変数の公開範囲区分
**公開可能（ブラウザに露出）:**
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase プロジェクトURL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - 匿名アクセス用キー（RLS前提で公開安全）

**非公開必須（サーバー専用）:**
- `SUPABASE_SERVICE_ROLE_KEY` - 管理者権限キー（絶対にクライアント露出禁止）

### 要件5

**ユーザーストーリー:** 責任ある開発者として、すべての情報源の利用規約に準拠し、システムが法的・倫理的に運用されることを確保したい。

#### 受入基準

1. 任意のデータソースにアクセスする時、システムはrobots.txtの指示を尊重すること
2. データを収集する時、システムは各ソースの利用規約に準拠すること
3. コンテンツを表示する時、システムは著作権ガイドラインを尊重すること
4. 利用規約が変更された場合、システムはコンプライアンスを維持するため容易に設定変更可能であること
5. リクエストを行う時、システムは適切なレート制限を実装すること

### 要件6

**ユーザーストーリー:** ユーザーとして、ニュースとスナップショット間の簡単なナビゲーションを持つ、クリーンでレスポンシブなWebインターフェースにより、両方の情報タイプに効率的にアクセスしたい。

#### 受入基準

1. ダッシュボードにアクセスする時、デスクトップとモバイルデバイスで適切に表示されること
2. app/layout.tsxにタブナビゲーション（ニュース/スナップショット）を常設し、全ページで利用可能にすること
3. ページ間をナビゲートする時、システムは`/`（ニュース）と`/snapshots`（スナップショット）間の明確な切り替えを提供すること
4. データを読み込む時、インターフェースは明確な読み込みインジケータを提供すること
5. データが利用できない時、システムは情報的なエラーメッセージを表示すること

### 要件7

**ユーザーストーリー:** システム管理者として、ニュース追跡とスナップショット管理の両方をサポートするデータモデルにより、必要な情報をすべて効率的に保存したい。

#### 受入基準

1. RSSデータを保存する時、システムはsources_raw（source, url, title, content, published_at列を含む）、al_tr_events（url列にUNIQUE制約）、al_tr_performanceテーブルを使用すること
2. スナップショットを管理する時、システムは適切なスキーマを持つal_offering_snapsテーブルを使用すること
3. スナップショット画像を保存する時、システムはURL、image_path、title、note、captured_atフィールドを維持すること
4. データ整合性を確保する時、システムはal_tr_eventsテーブルのurl列にUNIQUE制約、al_offering_snapsテーブルの(url, image_path)にユニーク制約を強制すること